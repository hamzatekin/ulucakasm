---
/**
 * Google Maps component - vanilla JS version
 * Uses the modern AdvancedMarkerElement API
 */
import { MAPS_LINK } from '../../lib/const.astro';
const zoom = 17;
const lat = 38.47771;
const lng = 27.35559;
---

<div id="map-container" class="map" data-zoom={zoom} data-lat={lat} data-lng={lng}></div>

<style>
  .map {
    height: 500px;
    width: 100%;
  }
</style>

<script define:vars={{ MAPS_LINK }}>
  const MAPS_SCRIPT_ID = 'google-maps-js';
  let mapInitialized = false;

  async function initMap() {
    const container = document.getElementById('map-container');
    if (!container) return;
    if (mapInitialized) return;
    mapInitialized = true;

    // Wait for Google Maps to be available
    if (!window.google?.maps || typeof google.maps.importLibrary !== 'function') {
      mapInitialized = false;
      return;
    }

    const zoom = parseInt(container.dataset.zoom || '17');
    const center = {
      lat: parseFloat(container.dataset.lat || '38.47771'),
      lng: parseFloat(container.dataset.lng || '27.35559'),
    };

    // Import the Map class
    const { Map } = await google.maps.importLibrary('maps');
    const { AdvancedMarkerElement } = await google.maps.importLibrary('marker');

    const map = new Map(container, {
      zoom,
      center,
      mapId: 'ulucak-asm-map', // Required for AdvancedMarkerElement
    });

    // Use the modern AdvancedMarkerElement
    new AdvancedMarkerElement({
      position: center,
      map: map,
      title: 'Kemalpaşa İbrahim-Hüsniye Özdurakoğlu Aile Sağlığı Merkezi',
    });
  }

  function loadMapsScript() {
    if (document.getElementById(MAPS_SCRIPT_ID)) return;
    const script = document.createElement('script');
    script.id = MAPS_SCRIPT_ID;
    script.src = `${MAPS_LINK}&callback=initMap`;
    script.async = true;
    script.defer = true;
    script.onerror = () => {
      mapInitialized = false;
      console.error('Failed to load Google Maps JS API');
    };
    document.head.appendChild(script);
  }

  const container = document.getElementById('map-container');
  if (!container) {
    // No container on this page; keep callback defined to avoid errors if loaded elsewhere.
    window.initMap = () => {};
  } else {
    // Expose initMap for the Google Maps callback
    window.initMap = initMap;

    if (window.google?.maps && typeof google.maps.importLibrary === 'function') {
      initMap();
    } else if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          if (entries.some((entry) => entry.isIntersecting)) {
            observer.disconnect();
            loadMapsScript();
          }
        },
        { rootMargin: '200px 0px' }
      );
      observer.observe(container);
    } else {
      loadMapsScript();
    }
  }
</script>
